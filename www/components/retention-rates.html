<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<dom-module id="retention-rates">
  <template>
    <style>
      :root {
        width: 100%;
      }

      google-chart {
        width: 100%;
      }
    </style>
    <div>hello world</div>
    <google-chart
  type='scatter'
  options='{"title": "Distribution of days in 2001Q1"}'
  cols='[{"label":"Month", "type":"number"}, {"label":"Days", "type":"number"}]'
  rows="{{retention_rates_data}}">
</google-chart>

  </template>
  <script>
    Polymer({
      is: 'retention-rates',
      properties: {
        /*
        userid: {
          type: 'String',
          observer: 'userid_changed'
        },
        domain_and_intervention_effectiveness_list: {
          type: Array,
        },
        */
        retention_rates_data: {
          type: Array,
        },
        isdemo: {
          type: Boolean,
          observer: 'isdemo_changed'
        }
      },
      ready: async function() {
        let self = this
        //this.retention_rates_data = [[0,0.7727272727272727],[1,0.4247594050743657],[2,0.4075413223140496],[3,0.3909595559080095],[4,0.42929806714140384],[5,0.4213263979193758],[6,0.407108239095315],[7,0.3855421686746988],[8,0.35498839907192575],[9,0.38154613466334164],[10,0.4013840830449827],[11,0.36082474226804123],[12,0.37992831541218636],[13,0.3744292237442922],[14,0.44761904761904764],[15,0.34146341463414637],[16,0.4010989010989011],[17,0.3558282208588957],[18,0.4383561643835616],[19,0.30985915492957744],[20,0.4068965517241379],[21,0.34507042253521125],[22,0.43859649122807015],[23,0.4105263157894737],[24,0.32673267326732675],[25,0.32608695652173914],[26,0.3854166666666667],[27,0.4788732394366197],[28,0.3],[29,0.3835616438356164],[30,0.4],[31,0.34545454545454546],[32,0.4067796610169492],[33,0.288135593220339],[34,0.21428571428571427],[35,0.2909090909090909],[36,0.37209302325581395],[37,0.36363636363636365],[38,0.4186046511627907],[39,0.4444444444444444],[40,0.4],[41,0.23255813953488372],[42,0.475],[43,0.5],[44,0.2727272727272727],[45,0.37777777777777777],[46,0.24],[47,0.2857142857142857],[48,0.2978723404255319],[49,0.3684210526315789],[50,0.2916666666666667],[51,0.3],[52,0.5128205128205128],[53,0.3076923076923077],[54,0.2608695652173913],[55,0.48148148148148145],[56,0.2962962962962963],[57,0.37037037037037035],[58,0.3333333333333333],[59,0.5217391304347826],[60,0.5862068965517241],[61,0.34615384615384615],[62,0.4444444444444444],[63,0.4482758620689655],[64,0.43478260869565216],[65,0.3888888888888889],[66,0.5],[67,0.42105263157894735],[68,0.4642857142857143],[69,0.42857142857142855],[70,0.6363636363636364],[71,0.4],[72,0.6875],[73,0.36],[74,0.35294117647058826],[75,0.23529411764705882],[76,0.6363636363636364],[77,0.45454545454545453],[78,0.5714285714285714],[79,0.55],[80,0.55],[81,0.4666666666666667],[82,0.35294117647058826],[83,0.35294117647058826],[84,0.5833333333333334],[85,0.42857142857142855],[86,0.3333333333333333],[87,0.6],[88,0.16666666666666666],[89,0.4],[90,0.09090909090909091],[91,0.4375],[92,0.7333333333333333],[93,0.5],[94,0.4666666666666667],[95,0.6666666666666666],[96,0.5714285714285714],[97,0.6],[98,0.4444444444444444],[99,0.5555555555555556],[100,0.4444444444444444],[101,0.5555555555555556],[102,0.5454545454545454],[103,0.42857142857142855],[104,0.625],[105,0.3333333333333333],[106,0.5],[107,0.4],[108,0.16666666666666666],[109,0.5833333333333334],[110,0.2857142857142857],[111,0],[112,0.25],[113,0.25],[114,0.3],[115,0.5],[116,0.3333333333333333],[117,0.375],[118,0.3333333333333333],[119,0.5],[120,0.375],[121,0],[122,0.6],[123,0.4],[124,0.42857142857142855],[125,0.4],[126,0.4],[127,0.25],[128,0.42857142857142855],[129,0.3333333333333333],[130,0.5],[131,0.25],[132,0],[133,0.2857142857142857],[134,0],[135,0.4],[136,0.42857142857142855],[137,0.14285714285714285],[138,0],[139,0.2857142857142857],[140,1],[141,0.5],[142,0.25],[143,0],[144,0.25],[145,1],[146,0.2857142857142857],[147,0],[148,0.14285714285714285],[149,0.5],[150,0],[151,1],[152,0],[153,0.6666666666666666],[154,0.3333333333333333],[155,0.3333333333333333],[156,0.25],[157,0.5],[158,0],[159,0.5],[160,0.5],[161,0.14285714285714285],[162,0],[163,0.3333333333333333],[164,0],[165,0.5],[166,0.8],[167,0.5],[168,0.6],[169,0.5],[170,0.3333333333333333],[172,0.2],[173,0.6666666666666666],[174,0.6666666666666666],[175,0.3333333333333333],[176,1],[177,0],[178,0.3333333333333333],[179,0],[180,0],[182,0],[183,0],[184,0.5],[185,0.6666666666666666],[186,0.75],[187,0.25],[188,0],[189,0],[190,1],[191,0],[192,0],[193,1],[194,0],[195,0.3333333333333333],[196,0],[197,0],[199,0],[200,1],[201,0],[202,0.5],[203,0],[204,1],[205,0],[206,0.5],[207,0],[208,0],[209,0.5],[210,0.75],[211,0],[212,0.5],[213,1],[214,0],[215,1],[216,0],[217,0],[218,0.4],[219,0],[220,0],[221,0],[222,0.16666666666666666],[223,0.25],[224,0],[225,0],[226,0],[227,0.5],[228,0],[229,1],[230,1],[231,0.5],[232,0],[233,0.5],[234,0],[235,1],[236,0.5],[238,1],[239,0],[240,0.3333333333333333],[241,0],[242,0.5],[244,0],[245,0.5],[246,0],[248,0],[249,0],[250,0],[251,0],[252,0.3333333333333333],[253,0.5],[255,0.5],[256,0],[257,0],[258,0],[259,0],[260,0],[261,0],[262,0],[263,0.3333333333333333],[264,1],[265,0],[266,1],[267,0],[269,0.5],[271,0],[272,1],[273,1],[275,0],[276,1],[279,0.5],[280,0],[282,1],[283,0],[284,0.5],[285,0],[287,0.5],[288,0.5],[289,0.6666666666666666],[291,0],[292,1],[293,0.5],[294,0],[296,0],[297,0],[298,0],[299,0.3333333333333333],[300,1],[302,0],[304,0.5],[305,0],[306,0],[307,0],[308,0],[309,0],[310,0],[311,0],[312,0],[318,0],[319,0],[324,1],[325,0],[331,0],[334,0],[335,0],[336,1],[338,1],[339,1],[340,1],[343,0],[345,0],[346,1],[347,0],[348,0],[349,1],[350,0],[351,0],[353,0],[354,0],[355,0],[356,1],[358,0],[362,0.5],[364,0],[367,1],[369,1],[370,0],[372,0],[377,0],[379,0],[381,0],[383,0],[387,0.5],[395,1],[396,0],[397,0],[398,0],[400,0],[402,0],[404,0],[406,0],[410,0],[413,0],[423,0],[425,0],[429,0],[431,0],[432,0],[434,1],[437,0],[440,1],[441,0],[444,0],[450,0],[451,0],[454,1],[457,1],[464,1],[465,0],[470,0],[471,0],[476,0],[483,1],[491,0],[493,0],[505,0],[508,1],[516,0],[517,0],[521,1],[525,1],[531,1],[539,0],[540,0],[543,1],[544,1],[546,0],[547,0],[554,1],[557,0],[573,0],[574,0],[575,0],[598,0],[600,1],[603,0],[612,0],[614,0],[616,0],[631,0],[640,0],[646,0],[654,1],[657,0],[661,1],[685,0],[706,0],[707,0],[713,0],[746,0],[779,0],[783,0],[786,0],[805,0],[812,0],[826,0],[844,0],[953,0],[1005,1],[1045,0],[1058,0],[1121,0],[1138,1],[1159,0],[1188,0],[1210,0],[1259,0],[1285,1],[1297,0.5],[1315,0],[1379,0],[1419,1],[1450,0],[1516,0],[1542,0],[1635,0],[1675,0],[1685,0],[1778,0],[1856,0],[2205,0],[2483,0],[2665,0],[3277,0],[3414,0],[6269,1],[6820,0],[7680,0],[18249,0]]
        let users = Promise.resolve(getjson('get_user_to_day_last_seen'))

        num_times_seen_vs_uninstall_rate_dict = {}
        coalesced = {}

        let d = new Date()
        let today = d.getTime()
        let one_day = 1000 * 60 * 60 * 24 

        users.then(async function(value) {
          for (let key in value) {
            let userid = key
            let date = Number(value[key])
            let day_last_seen = new Date(date / 10000, (date % 10000 / 100) - 1, date % 100)
            let days_since_last_active = Math.round((today - day_last_seen.getTime())/one_day)

            let intervention_count_dict = await get_intervention_to_num_times_seen(userid)
            for (let intervention in intervention_count_dict){
              if (num_times_seen_vs_uninstall_rate_dict[intervention] == null) {
                num_times_seen_vs_uninstall_rate_dict[intervention] = {}
              }

              let num_times_seen = intervention_count_dict[intervention]
              if (num_times_seen_vs_uninstall_rate_dict[intervention][num_times_seen] == null) {
                // [uninstall, not uninstalled]
                num_times_seen_vs_uninstall_rate_dict[intervention][num_times_seen] = [0,0]
              }

              if (coalesced[num_times_seen] == null) {
                coalesced[num_times_seen] = [0,0]
              }

              if (days_since_last_active > 3) {
                num_times_seen_vs_uninstall_rate_dict[intervention][num_times_seen][0]++
                coalesced[num_times_seen][0]++
              } else {
                num_times_seen_vs_uninstall_rate_dict[intervention][num_times_seen][1]++
                coalesced[num_times_seen][1]++
              }
            }
          }

          let data = []

          let dummy = ''

          for (let key in coalesced) {
            console.log(key, coalesced[key])
            let uninstall = coalesced[key][0]
            let non_uninstall = coalesced[key][1]
            let p_uninstall = uninstall / (uninstall + non_uninstall)
            if (parseInt(key) < 450) {
              data.push([parseInt(key), p_uninstall])
            }
            dummy += '['+ key + ',' + p_uninstall.toString() + '],'
            console.log(dummy)
          }
          console.log(data)
          self.retention_rates_data = data
          
          console.log(dummy)
        })

        // console.log(num_times_seen_vs_uninstall_rate_dict)
        // let install_times = await get_user_to_install_times()
        // console.log(install_times)
      }
    });
  </script>

</dom-module>
