<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<dom-module id="retention-curve-experiment">
  <template>
    <style>
      #retention_curve_experiment {
        width: 100%;
        height: 600px;
      }
      #retention_curve_experiment2 {
        width: 100%;
        height: 600px;
      }
      #retention_curve_experiment3 {
        width: 100%;
        height: 600px;
      }
      #retention_curve_experiment4 {
        width: 100%;
        height: 600px;
      }
    </style>
    <google-chart
      type="line"
      id="retention_curve_experiment"
      cols='[{"label": "Day", "type": "number"},{"label": "Number of users retained", "type": "number"},{"label": "Fraction of users retained", "type": "number", "role": "tooltip", "p": {"html": true}}]'
      rows="{{data}}"
      options='{"tooltip": {"isHtml": true}, "legend": "none"}'
    ></google-chart>
    <google-chart
      type="line"
      id="retention_curve_experiment2"
      cols='[{"label": "Day", "type": "number"},{"label": "Number of users retained", "type": "number"},{"label": "Fraction of users retained", "type": "number", "role": "tooltip", "p": {"html": true}}]'
      rows="{{data2}}"
      options='{"tooltip": {"isHtml": true}, "legend": "none"}'
    ></google-chart>
    <google-chart
      type="line"
      id="retention_curve_experiment3"
      cols='[{"label": "Day", "type": "number"},{"label": "Number of users retained", "type": "number"},{"label": "Fraction of users retained", "type": "number", "role": "tooltip", "p": {"html": true}}]'
      rows="{{data3}}"
      options='{"tooltip": {"isHtml": true}, "legend": "none"}'
    ></google-chart>
    <google-chart
      type="line"
      id="retention_curve_experiment4"
      cols='[{"label": "Day", "type": "number"},{"label": "all", "type": "number"},{"label": "half", "type": "number"},{"label": "one", "type": "number"}, {"label": "pre-experiment", "type": "number"}]'
      rows="{{data4}}"
      options='{"tooltip": {"isHtml": true}}'
    ></google-chart>
  </template>
  <script>
    Polymer({
      is: 'retention-curve-experiment',
      properties: {

      },
      ready: async function() {
        let user_to_install_data = await get_user_to_install_data_cached()
        console.log('user_to_install_data')
        console.log(user_to_install_data)
        let user_to_first_active_since_today = await list_first_active_date_for_all_users_since_today()
        let all_user_list = Object.keys(user_to_first_active_since_today)
        let condition_to_users = {}
        let user_to_interventions_seen = await list_intervention_logs_for_all_users_cached()
        let user_list_historic = []
        for (let userid of all_user_list) {
          let interventions_seen = user_to_interventions_seen[userid]
          if (interventions_seen == null || interventions_seen.length == 0) continue
          user_list_historic.push(userid)
        }
        //let user_list_historic_twoweeks = []
        //for (let userid of all_user_list ) {
          
        //}
        for (let userid of all_user_list) {
          let install_info = user_to_install_data[userid]
          if (install_info == null) {
            // don't have install event logged
            continue
          }
          if (install_info.chrome_runtime_id != "obghclocpdgcekcognpkblghkedcpdgd") {
            // not running production version
            continue
          }
          if (install_info.last_visit_to_chrome_store == -1 && install_info.last_visit_to_website == -1) {
            // fake user or autoinstall
            continue
          } 
          //console.log(userid)
          let interventions_seen = user_to_interventions_seen[userid]
          //if (interventions_seen == null || interventions_seen.length == 0) continue
          let condition = await get_experiment_condition_for_user_cached(userid)
          if (condition == 'none') continue
          //let default_interventions = await get_default_interventions_for_user(userid)
          //console.log('default interventions are')
          //console.log(default_interventions)
          let onboarding_completed = await get_did_user_complete_onboarding_cached(userid)
          //if (!onboarding_completed) continue
          let intervention_to_num_times_seen = await get_intervention_to_num_times_seen(userid)
          let total_interventions_seen = 0
          let total_facebook_interventions_seen = 0
          for (let intervention_name of Object.keys(intervention_to_num_times_seen)) {
            let num_times_seen = intervention_to_num_times_seen[intervention_name]
            total_interventions_seen += num_times_seen
            if (intervention_name.startsWith('facebook:')) {
              total_facebook_interventions_seen += num_times_seen
            }
          }
          if (total_interventions_seen < 10) {
            //continue
          }
          if (total_facebook_interventions_seen < 1) {
            //continue
          }
          if (condition_to_users[condition] == null) {
            condition_to_users[condition] = []
          }
          condition_to_users[condition].push(userid)
        }
        let condition_list = [
          'all_of_defaults',
          'half_of_defaults',
          'one'
        ]
        let days_to_analyze = 7
        console.log('sample sizes:')
        let retention_data = await get_retention_curves_for_users(condition_to_users['all_of_defaults'], days_to_analyze)
        console.log(retention_data[0])
        this.data = math.range(0, days_to_analyze + 1).map((i) => [i, retention_data[i] / retention_data[0], retention_data[i]]).toArray()
        let retention_data2 = await get_retention_curves_for_users(condition_to_users['half_of_defaults'], days_to_analyze)
        console.log(retention_data2[0])
        this.data2 = math.range(0, days_to_analyze + 1).map((i) => [i, retention_data2[i] / retention_data2[0], retention_data2[i]]).toArray()
        let retention_data3 = await get_retention_curves_for_users(condition_to_users['one'], days_to_analyze)
        console.log(retention_data3[0])
        console.log(retention_data3)
        let retention_data4 = await get_retention_curves_for_users(user_list_historic, days_to_analyze)
        console.log(retention_data4[0])
        this.data3 = math.range(0, days_to_analyze + 1).map((i) => [i, retention_data3[i] / retention_data3[0], retention_data3[i]]).toArray()
        this.data4 = math.range(0, days_to_analyze + 1).map((i) => [i, retention_data[i] / retention_data[0], retention_data2[i] / retention_data2[0], retention_data3[i] / retention_data3[0], retention_data4[i] / retention_data4[0]]).toArray()
        console.log('data for making logrank test')
        let lifetimes1 = await get_lifetimes_and_whether_attrition_was_observed_for_users(condition_to_users['all_of_defaults'])
        let lifetimes2 = await get_lifetimes_and_whether_attrition_was_observed_for_users(condition_to_users['half_of_defaults'])
        let lifetimes3 = await get_lifetimes_and_whether_attrition_was_observed_for_users(condition_to_users['one'])
        console.log(JSON.stringify({
          all_of_defaults: lifetimes1,
          half_of_defaults: lifetimes2,
          one: lifetimes3,
        }))
      }
    })
  </script>
</dom-module>