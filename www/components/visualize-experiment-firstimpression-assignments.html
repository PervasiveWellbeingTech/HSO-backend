<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<dom-module id="visualize-experiment-firstimpression-assignments">
  <template>
    <style>
      #retention_curve_general {
        width: 100%;
        height: 600px;
      }
    </style>
    <h1>All Users in experiment firstimpression</h1>

    <template is="dom-repeat" items="{{firstimpression_users}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition none</h1>

    <template is="dom-repeat" items="{{firstimpression_users_none}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition info</h1>

    <template is="dom-repeat" items="{{firstimpression_users_info}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition power</h1>

    <template is="dom-repeat" items="{{firstimpression_users_power}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

  </template>
  <script>
    Polymer({
      is: 'visualize-experiment-firstimpression-assignments',
      properties: {
        
      },
      /*
      display_user_list: function(user_list, container) {
        $('#num_active_users').text(user_ids.length)
        for (let user_id of user_ids) {
          $(container).append($('<a href="/viewuser.html?userid=' + user_id + '">' + user_id + '</a>'))
          $('#user_list').append($('<br>'))
        }
      },
      */
      getkey: function(userid, user_to_initial_condition_info) {
        let output = user_to_initial_condition_info[userid]
        if (typeof(output) == 'string') {
          return output
        } else {
          return JSON.stringify(output)
        }
      },
      initial_condition_info_for_user_printable: function(userid, user_to_initial_condition_info) {
        return JSON.stringify(user_to_initial_condition_info[userid])
      },
      ready: async function() {
        console.log('ready in firstimpression assignments')
        let user_to_selection_algorithm = {}
        let selection_algorithm_and_users_list = []
        let selection_algorithm_to_idx = {}
        this.first_active_date_for_all_users = await list_first_active_date_for_all_users()
        this.last_active_date_for_all_users = await list_last_active_date_for_all_users()
        this.user_to_all_install_ids = await get_user_to_all_install_ids_cached()
        this.user_to_is_unofficial = await get_user_to_is_unofficial_cached()
        let skip_unofficial = true
        let skip_duplicate_install_ids = true
        let skip_users_who_did_not_complete_onboarding = true
        let skip_users_who_saw_no_interventions = true
        let user_to_initial_condition_info = {}
        let user_to_habitlab_versions_impressions = {}
        let user_to_habitlab_version_install = {}
        let all_firstimpression_users = await get_all_users_in_firstimpression_experiment_cached()
        let skipped_users = []
        let user_skipped_reasons = new pycollections.Counter()
        let firstimpression_users = []
        let user_to_num_interventions_seen = {}
        let user_to_num_unique_interventions_seen = {}
        let user_to_experiment_start_timestamp = {}
        for (let userid of all_firstimpression_users) {
          let experiment_vars_list = await get_collection_for_user_cached(userid, 'synced:experiment_vars')
          if (skip_unofficial && this.user_to_is_unofficial[userid] != false) {
            //console.log('skipping unofficial')
            skipped_users.push(userid)
            user_skipped_reasons.update({'unofficial': 1})
            continue
          }
          if (skip_duplicate_install_ids && (this.user_to_all_install_ids[userid] == null || this.user_to_all_install_ids[userid].length != 1)) {
            //console.log('skipping duplicate')
            skipped_users.push(userid)
            user_skipped_reasons.update({'duplicate_install': 1})
            continue
          }
          let intervention_to_num_times_seen = await get_intervention_to_num_times_seen_newsession_nonpreview(userid)
          let total_num_times_interventions_seen = prelude.sum(Object.values(intervention_to_num_times_seen))
          //console.log(total_num_times_interventions_seen)
          user_to_num_interventions_seen[userid] = total_num_times_interventions_seen
          let num_unique_interventions_seen = Object.values(intervention_to_num_times_seen).filter(x => x > 0).length
          user_to_num_unique_interventions_seen[userid] = num_unique_interventions_seen
          if (skip_users_who_saw_no_interventions && total_num_times_interventions_seen == 0) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'saw_no_nonpreview_interventions': 1})
            continue
          }
          let did_user_complete_onboarding = await get_did_user_complete_onboarding_cached(userid)
          if (skip_users_who_did_not_complete_onboarding && !did_user_complete_onboarding) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'did_not_complete_onboarding': 1})
            continue
          }
          firstimpression_users.push(userid)
          let habitlab_versions_for_user = []
          let habitlab_versions_for_user_set = new Set()
          for (let x of experiment_vars_list) {
            if (x.key == 'intervention_firstimpression_notice') {
              let version = x.habitlab_version
              let condition = x.val
              let timestamp = x.timestamp
              if (user_to_habitlab_version_install[userid] == null) {
                user_to_habitlab_version_install[userid] = version
                user_to_initial_condition_info[userid] = condition
                user_to_experiment_start_timestamp[userid] = timestamp
              }
            }
            if (x.key == 'intervention_firstimpression_notice_seenlist') {
              let version = x.habitlab_version
              if (!habitlab_versions_for_user_set.has(version)) {
                habitlab_versions_for_user_set.add(version)
                habitlab_versions_for_user.push(version)
              }
            }
          }
          user_to_habitlab_versions_impressions[userid] = habitlab_versions_for_user
        }
        console.log(user_skipped_reasons.items())
        this.user_to_experiment_start = mapobj(user_to_experiment_start_timestamp, (key, val) => [key, moment(val).toString()])
        this.user_to_num_interventions_seen = user_to_num_interventions_seen
        this.user_to_num_unique_interventions_seen = user_to_num_unique_interventions_seen
        this.skipped_users = skipped_users
        this.firstimpression_users = firstimpression_users
        this.user_to_initial_condition_info = user_to_initial_condition_info
        this.user_to_habitlab_versions_impressions = user_to_habitlab_versions_impressions
        this.user_to_habitlab_version_install = user_to_habitlab_version_install
        this.firstimpression_users_none = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'none')
        this.firstimpression_users_info = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'info')
        this.firstimpression_users_power = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'power')
        console.log(firstimpression_users)
        console.log(this.firstimpression_users_none)
        console.log(this.firstimpression_users_info)
        console.log(this.firstimpression_users_power)
      },
    })
  </script>
</dom-module>
