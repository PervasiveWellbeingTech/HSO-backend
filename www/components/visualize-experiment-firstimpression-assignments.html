<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<dom-module id="visualize-experiment-firstimpression-assignments">
  <template>
    <style>
      #retention_curve_general {
        width: 100%;
        height: 600px;
      }
    </style>
    <h1>All Users in experiment firstimpression</h1>

    <template is="dom-repeat" items="{{firstimpression_users}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>days alive {{getkey(userid, user_to_days_alive)}}</div>
        <div>attritioned {{getkey(userid, user_to_has_attritioned)}}</div>
        <div>attritioned within 2 days {{getkey(userid, user_to_attritioned_within_2days)}}</div>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>last intevention seen {{getkey(userid, user_to_last_intervention_seen)}}</div>
        <div>last intevention seen time {{getkey(userid, user_to_last_intervention_seen_time)}}</div>
        <div>interventions disabled and sources {{getkey(userid, user_to_interventions_disabled_and_sources)}}</div>
        <div>interventions enabled and sources {{getkey(userid, user_to_interventions_enabled_and_sources)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition none</h1>

    <template is="dom-repeat" items="{{firstimpression_users_none}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>days alive {{getkey(userid, user_to_days_alive)}}</div>
        <div>attritioned {{getkey(userid, user_to_has_attritioned)}}</div>
        <div>attritioned within 2 days {{getkey(userid, user_to_attritioned_within_2days)}}</div>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>last intevention seen {{getkey(userid, user_to_last_intervention_seen)}}</div>
        <div>last intevention seen time {{getkey(userid, user_to_last_intervention_seen_time)}}</div>
        <div>interventions disabled and sources {{getkey(userid, user_to_interventions_disabled_and_sources)}}</div>
        <div>interventions enabled and sources {{getkey(userid, user_to_interventions_enabled_and_sources)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition info</h1>

    <template is="dom-repeat" items="{{firstimpression_users_info}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>days alive {{getkey(userid, user_to_days_alive)}}</div>
        <div>attritioned {{getkey(userid, user_to_has_attritioned)}}</div>
        <div>attritioned within 2 days {{getkey(userid, user_to_attritioned_within_2days)}}</div>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>last intevention seen {{getkey(userid, user_to_last_intervention_seen)}}</div>
        <div>last intevention seen time {{getkey(userid, user_to_last_intervention_seen_time)}}</div>
        <div>interventions disabled and sources {{getkey(userid, user_to_interventions_disabled_and_sources)}}</div>
        <div>interventions enabled and sources {{getkey(userid, user_to_interventions_enabled_and_sources)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

    <h1>All users in condition power</h1>

    <template is="dom-repeat" items="{{firstimpression_users_power}}" as="userid">
      <div>
        <a href="/viewuser.html?userid={{userid}}">{{userid}}</a>
        <div>days alive {{getkey(userid, user_to_days_alive)}}</div>
        <div>attritioned {{getkey(userid, user_to_has_attritioned)}}</div>
        <div>attritioned within 2 days {{getkey(userid, user_to_attritioned_within_2days)}}</div>
        <div>first active {{getkey(userid, first_active_date_for_all_users)}}</div>
        <div>last active {{getkey(userid, last_active_date_for_all_users)}}</div>
        <div>experiment start {{getkey(userid, user_to_experiment_start)}}</div>
        <div>install ids {{getkey(userid, user_to_all_install_ids)}}</div>
        <div>is unofficial {{getkey(userid, user_to_is_unofficial)}}</div>
        <div>condition {{getkey(userid, user_to_initial_condition_info)}}</div>
        <div>num times an intervention was seen {{getkey(userid, user_to_num_interventions_seen)}}</div>
        <div>num unique interventions seen {{getkey(userid, user_to_num_unique_interventions_seen)}}</div>
        <div>last intevention seen {{getkey(userid, user_to_last_intervention_seen)}}</div>
        <div>last intevention seen time {{getkey(userid, user_to_last_intervention_seen_time)}}</div>
        <div>interventions disabled and sources {{getkey(userid, user_to_interventions_disabled_and_sources)}}</div>
        <div>interventions enabled and sources {{getkey(userid, user_to_interventions_enabled_and_sources)}}</div>
        <div>version at install time {{getkey(userid, user_to_habitlab_version_install)}}</div>
        <div>version at impressions {{getkey(userid, user_to_habitlab_versions_impressions)}}</div>
        <br>
      </div>
    </template>

    <br><br>

  </template>
  <script>

    function compute_daily_times_on_site(session_info_list) {
      let output = []
      let day_to_total_time_spent = {}
      for (let session_info of session_info_list) {
        let time_spent = session_info.time_spent
        let day = session_info.localepoch
        if (day_to_total_time_spent[day] == null) {
          day_to_total_time_spent[day] = 0
        }
        day_to_total_time_spent[day] += time_spent
      }
      return Object.values(day_to_total_time_spent)
    }

    Polymer({
      is: 'visualize-experiment-firstimpression-assignments',
      properties: {
        
      },
      /*
      display_user_list: function(user_list, container) {
        $('#num_active_users').text(user_ids.length)
        for (let user_id of user_ids) {
          $(container).append($('<a href="/viewuser.html?userid=' + user_id + '">' + user_id + '</a>'))
          $('#user_list').append($('<br>'))
        }
      },
      */
      getkey: function(userid, user_to_initial_condition_info) {
        let output = user_to_initial_condition_info[userid]
        if (typeof(output) == 'string') {
          return output
        } else {
          return JSON.stringify(output)
        }
      },
      initial_condition_info_for_user_printable: function(userid, user_to_initial_condition_info) {
        return JSON.stringify(user_to_initial_condition_info[userid])
      },
      ready: async function() {
        console.log('ready in firstimpression assignments')
        let user_to_selection_algorithm = {}
        let selection_algorithm_and_users_list = []
        let selection_algorithm_to_idx = {}
        this.first_active_date_for_all_users = await list_first_active_date_for_all_users()
        this.last_active_date_for_all_users = await list_last_active_date_for_all_users()
        this.first_active_date_for_all_install_ids = await list_first_active_date_for_all_install_ids()
        this.last_active_date_for_all_install_ids = await list_last_active_date_for_all_install_ids()
        this.user_to_all_install_ids = await get_user_to_all_install_ids_cached()
        this.user_to_is_unofficial = await get_user_to_is_unofficial_cached()
        let skip_unofficial = true
        let exclude_users_starting_within_3_days = false
        let skip_notfirst_install_ids = false
        let skip_duplicate_install_ids = false
        let skip_users_who_did_not_complete_onboarding = false //true
        let skip_users_who_saw_no_interventions = false
        let skip_users_with_no_sessions = false
        //let versions_to_skip = ['1.0.211', '1.0.212', '1.0.213', '1.0.214', '1.0.215']
        let versions_to_skip = []
        let user_to_initial_condition_info = {}
        let user_to_habitlab_versions_impressions = {}
        let user_to_habitlab_version_install = {}
        let all_firstimpression_install_ids = await get_all_install_ids_in_firstimpression_experiment_cached()
        let all_firstimpression_users = await get_all_users_in_firstimpression_experiment_cached()
        let skipped_users = []
        let user_skipped_reasons = new pycollections.Counter()
        let firstimpression_users = []
        let user_to_num_interventions_seen = {}
        let user_to_num_unique_interventions_seen = {}
        let user_to_experiment_start_timestamp = {}
        let user_to_last_intervention_seen_time = {}
        let user_to_last_intervention_seen = {}
        let user_to_interventions_disabled_and_sources = {}
        let user_to_interventions_enabled_and_sources = {}
        let user_to_days_ago_last_seen = {}
        let user_to_days_alive = {}
        let user_to_has_attritioned = {}
        let install_id_to_has_attritioned = {}
        let user_to_attritioned_within_2days = {}
        let install_id_to_attritioned_within_2days = {}
        let install_id_to_user_id = await get_install_id_to_user_id()
        //console.log(install_id_to_user_id)
        let user_id_to_all_install_ids = await get_user_to_all_install_ids_cached()
        //for (let userid of all_firstimpression_users) {
        let validusers = {}
        let validinstalls = {}
        let csv_data = []
        let csv_data_perday = []
        let userid_to_day_info_list = {}
        for (let install_id of all_firstimpression_install_ids) {
          let userid = install_id_to_user_id[install_id]
          let all_install_ids = user_id_to_all_install_ids[userid]
          //console.log('install id is ' + install_id + ' user id is ' + userid + ' first install id is ' + all_install_ids[0])
          //console.log(all_install_ids)
          let have_multiple_install_ids = all_install_ids.length > 1
          let is_first_install_id = install_id == all_install_ids[0]
          if (install_id == all_install_ids[0]) {
            validusers[userid] = true
            validinstalls[install_id] = true
          }
          let experiment_vars_list = await get_collection_for_user_cached(userid, 'synced:experiment_vars')
          //console.log(experiment_vars_list)
          experiment_vars_list_install_id = experiment_vars_list.filter(x => x.install_id == install_id)
          if (skip_unofficial && (this.user_to_is_unofficial[userid] != false)) {
            //console.log('skipping unofficial')
            skipped_users.push(userid)
            user_skipped_reasons.update({'unofficial': 1})
            continue
          }
          if (skip_notfirst_install_ids && (install_id != all_install_ids[0])) {
            //console.log('skipping unofficial')
            skipped_users.push(userid)
            user_skipped_reasons.update({'notfirst_install': 1})
            continue
          }
          if (skip_duplicate_install_ids && (this.user_to_all_install_ids[userid] == null || this.user_to_all_install_ids[userid].length != 1)) {
            //console.log('skipping duplicate')
            skipped_users.push(userid)
            user_skipped_reasons.update({'duplicate_install': 1})
            continue
          }
          let intervention_to_num_times_seen_all = await get_intervention_to_num_times_seen(userid)
          let total_num_times_interventions_seen_all = prelude.sum(Object.values(intervention_to_num_times_seen_all))
          let intervention_to_num_times_seen = await get_intervention_to_num_times_seen_newsession_nonpreview(userid)
          let total_num_times_interventions_seen = prelude.sum(Object.values(intervention_to_num_times_seen))
          //console.log(total_num_times_interventions_seen)
          user_to_num_interventions_seen[userid] = total_num_times_interventions_seen
          let num_unique_interventions_seen = Object.values(intervention_to_num_times_seen).filter(x => x > 0).length
          user_to_num_unique_interventions_seen[userid] = num_unique_interventions_seen
          if (skip_users_who_saw_no_interventions && total_num_times_interventions_seen == 0) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'saw_no_nonpreview_interventions': 1})
            continue
          }
          let did_user_complete_onboarding = await get_did_user_complete_onboarding_cached(userid)
          if (skip_users_who_did_not_complete_onboarding && !did_user_complete_onboarding) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'did_not_complete_onboarding': 1})
            continue
          }
          let session_info_list = await get_session_info_list_for_install_id_detailed_cached(install_id)
          if (skip_users_with_no_sessions && session_info_list.length == 0) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'no_sessions': 1})
            continue
          }


          //console.log(session_info_list)
          let session_times_on_site = session_info_list.map(x => x.time_spent)
          let daily_times_on_site = compute_daily_times_on_site(session_info_list)
          let mean_session_time = prelude.mean(session_times_on_site)
          let mean_daily_time = prelude.mean(daily_times_on_site)
          let is_session_list_empty = session_info_list.length == 0
          let is_preview = false
          let domain = ''
          let intervention = ''
          if (!is_session_list_empty) {
            is_preview = session_info_list[0].is_preview
            domain = session_info_list[0].domain
            intervention = session_info_list[0].intervention
          }

          /*
          if (session_info_list[0].is_preview) {
            continue
          }
          //if (session_info_list[0].domain == 'www.youtube.com') {
          //  continue
          //}
          if (session_info_list[0].domain != 'www.facebook.com') {
            continue
          }
          console.log(session_info_list)
          */
          let first_active_date = this.first_active_date_for_all_install_ids[install_id]
          let last_active_date = this.last_active_date_for_all_install_ids[install_id]
          let first_active_days_since_today = convert_date_to_days_since_today(first_active_date)
          let last_active_days_since_today = convert_date_to_days_since_today(last_active_date)
          let first_active_date_userid = this.first_active_date_for_all_users[userid]
          let last_active_date_userid = this.last_active_date_for_all_users[userid]
          let first_active_days_since_today_userid = convert_date_to_days_since_today(first_active_date_userid)
          let last_active_days_since_today_userid = convert_date_to_days_since_today(last_active_date_userid)
          if (exclude_users_starting_within_3_days && first_active_days_since_today <= 3) {
            skipped_users.push(userid)
            user_skipped_reasons.update({'started_within_3_days': 1})
            continue
          }
          if (versions_to_skip.length > 0) {
            let saw_blacklisted_version = false
            for (let x of experiment_vars_list) {
              if (x.key == 'intervention_firstimpression_notice') {
                let version = x.habitlab_version
                if (versions_to_skip.includes(version)) {
                  saw_blacklisted_version = true
                }
              }
            }
            if (saw_blacklisted_version) {
              skipped_users.push(userid)
              user_skipped_reasons.update({'blacklisted_version': 1})
              continue
            }
          }
          let days_alive = first_active_days_since_today - last_active_days_since_today
          let days_alive_userid = first_active_days_since_today_userid - last_active_days_since_today_userid
          user_to_days_alive[userid] = days_alive
          user_to_days_ago_last_seen[userid] = last_active_days_since_today
          let did_user_attrition = last_active_days_since_today > 2
          let did_user_attrition_userid = last_active_days_since_today_userid > 2
          user_to_has_attritioned[userid] = did_user_attrition
          install_id_to_has_attritioned[install_id] = did_user_attrition
          let did_user_attrition_within_2days = did_user_attrition // && (days_alive < 2)
          user_to_attritioned_within_2days[userid] = did_user_attrition_within_2days
          install_id_to_attritioned_within_2days[install_id] = did_user_attrition_within_2days
          let interventions_disabled_and_sources = await get_interventions_disabled_and_sources_cached(userid)
          user_to_interventions_disabled_and_sources[userid] = interventions_disabled_and_sources
          let interventions_enabled_and_sources = await get_interventions_enabled_and_sources_cached(userid)
          user_to_interventions_enabled_and_sources[userid] = interventions_enabled_and_sources
          let last_intervention_seen_and_time = await get_last_intervention_seen_and_time_cached(userid)
          let last_intervention_seen = last_intervention_seen_and_time.intervention
          let last_intervention_seen_time = last_intervention_seen_and_time.time
          user_to_last_intervention_seen_time[userid] = last_intervention_seen_time
          user_to_last_intervention_seen[userid] = last_intervention_seen
          firstimpression_users.push(userid)
          let habitlab_versions_for_user = []
          let habitlab_versions_for_user_set = new Set()
          let initial_condition_for_user = ''
          let initial_habitlab_version_for_user = ''
          let saw_multiple_conditions_for_user = false
          let did_user_see_notice = false
          for (let x of experiment_vars_list) {
            if (x.key == 'intervention_firstimpression_notice') {
              let version = x.habitlab_version
              let condition = x.val
              let timestamp = x.timestamp
              if (initial_condition_for_user != '') {
                saw_multiple_conditions_for_user = true
              }
              if (user_to_habitlab_version_install[userid] == null) {
                user_to_habitlab_version_install[userid] = version
                user_to_initial_condition_info[userid] = condition
                user_to_experiment_start_timestamp[userid] = timestamp
                initial_condition_for_user = condition
                initial_habitlab_version_for_user = version
              }
            }
            if (x.key == 'intervention_firstimpression_notice_seenlist') {
              did_user_see_notice = true
              let version = x.habitlab_version
              if (!habitlab_versions_for_user_set.has(version)) {
                habitlab_versions_for_user_set.add(version)
                habitlab_versions_for_user.push(version)
              }
            }
          }
          user_to_habitlab_versions_impressions[userid] = habitlab_versions_for_user
          if (userid == null) {
            continue
          }
          did_user_see_notice_or_is_none = did_user_see_notice || (initial_condition_for_user == 'none' || initial_condition_for_user == '')
          did_user_see_notice_or_is_none_and_saw_interventions = did_user_see_notice || (total_num_times_interventions_seen_all > 0 && (initial_condition_for_user == 'none' || initial_condition_for_user == ''))

          let day_info_list = convert_session_info_list_to_day_info_list(session_info_list)
          for (let day_info of day_info_list) {
            day_info.condition = initial_condition_for_user
            day_info.initial_habitlab_version_for_user = initial_habitlab_version_for_user
            day_info.did_user_see_notice = did_user_see_notice
            day_info.did_user_see_notice_or_is_none = did_user_see_notice_or_is_none
            day_info.did_user_see_notice_or_is_none_and_saw_interventions = did_user_see_notice_or_is_none_and_saw_interventions
            csv_data_perday.push(day_info)
          }

          userid_to_day_info_list[userid] = day_info_list

          csv_data.push({
            userid: userid,
            install_id: install_id,
            condition: initial_condition_for_user,
            saw_multiple_conditions_for_user: saw_multiple_conditions_for_user,
            days_alive: days_alive_userid,
            days_alive_install_id: days_alive,
            attritioned: did_user_attrition_userid,
            attritioned_install_id: did_user_attrition,
            last_active_days_since_today_install_id: last_active_days_since_today,
            last_active_days_since_today: last_active_days_since_today_userid,
            is_first_install_id: is_first_install_id,
            have_multiple_install_ids: have_multiple_install_ids,
            is_session_list_empty: is_session_list_empty,
            is_preview: is_preview,
            domain: domain,
            intervention: intervention,
            initial_habitlab_version_for_user: initial_habitlab_version_for_user,
            did_user_see_notice: did_user_see_notice,
            did_user_see_notice_or_is_none: did_user_see_notice_or_is_none,
            did_user_see_notice_or_is_none_and_saw_interventions: did_user_see_notice_or_is_none_and_saw_interventions,
            total_num_times_interventions_seen: total_num_times_interventions_seen,
            total_num_times_interventions_seen_all: total_num_times_interventions_seen_all,
            did_user_complete_onboarding: did_user_complete_onboarding,
            session_times_on_site: '"' + JSON.stringify(session_times_on_site) + '"',
            daily_times_on_site: '"' + JSON.stringify(daily_times_on_site) + '"',
            mean_daily_time: mean_daily_time,
            mean_session_time: mean_session_time,
          })
        }
        function get_attritioned_for_users(user_list) {
          let output = []
          for (let userid of user_list) {
            let attritioned = user_to_attritioned_within_2days[userid]
            output.push(attritioned)
          }
          return output
        }
        function get_attritioned_ratio_for_users(user_list) {
          let attritioned_list = get_attritioned_for_users(user_list)
          return attritioned_list.filter(x => x == 1).length / attritioned_list.length
        }
        function get_attritioned_nonattritioned_counts_for_users(user_list) {
          let attritioned_list = get_attritioned_for_users(user_list)
          return [attritioned_list.filter(x => x == 1).length, attritioned_list.filter(x => x == 0).length]
        }
        function get_attritioned_for_install_ids(install_id_list) {
          let output = []
          for (let install_id of install_id_list) {
            let attritioned = install_id_to_attritioned_within_2days[install_id]
            output.push(attritioned)
          }
          return output
        }
        function get_attritioned_ratio_for_install_ids(install_id_list) {
          let attritioned_list = get_attritioned_for_install_ids(install_id_list)
          return attritioned_list.filter(x => x == 1).length / attritioned_list.length
        }
        function get_attritioned_nonattritioned_counts_for_install_ids(install_id_list) {
          let attritioned_list = get_attritioned_for_install_ids(install_id_list)
          return [attritioned_list.filter(x => x == 1).length, attritioned_list.filter(x => x == 0).length]
        }
        console.log('valid users')
        console.log(Object.keys(validusers))
        console.log('valid installs')
        console.log(Object.keys(validinstalls))
        console.log(user_skipped_reasons.items())
        this.user_to_attritioned_within_2days = user_to_attritioned_within_2days
        this.user_to_has_attritioned = user_to_has_attritioned
        this.user_to_days_alive = user_to_days_alive
        this.user_to_interventions_disabled_and_sources = user_to_interventions_disabled_and_sources
        this.user_to_interventions_enabled_and_sources = user_to_interventions_enabled_and_sources
        this.user_to_last_intervention_seen = user_to_last_intervention_seen
        this.user_to_last_intervention_seen_time = mapobj(user_to_last_intervention_seen_time, (key, val) => [key, moment(val).toString()])
        this.user_to_experiment_start = mapobj(user_to_experiment_start_timestamp, (key, val) => [key, moment(val).toString()])
        this.user_to_num_interventions_seen = user_to_num_interventions_seen
        this.user_to_num_unique_interventions_seen = user_to_num_unique_interventions_seen
        this.skipped_users = skipped_users
        this.firstimpression_users = firstimpression_users
        this.user_to_initial_condition_info = user_to_initial_condition_info
        this.user_to_habitlab_versions_impressions = user_to_habitlab_versions_impressions
        this.user_to_habitlab_version_install = user_to_habitlab_version_install
        this.firstimpression_users_none = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'none')
        this.firstimpression_users_info = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'info')
        this.firstimpression_users_power = firstimpression_users.filter(x => user_to_initial_condition_info[x] == 'power')
        console.log(firstimpression_users)
        console.log(this.firstimpression_users_none)
        console.log(this.firstimpression_users_info)
        console.log(this.firstimpression_users_power)
        console.log(get_attritioned_ratio_for_users(this.firstimpression_users_none))
        console.log(get_attritioned_ratio_for_users(this.firstimpression_users_info))
        console.log(get_attritioned_ratio_for_users(this.firstimpression_users_power))
        console.log(get_attritioned_nonattritioned_counts_for_users(this.firstimpression_users_none))
        console.log(get_attritioned_nonattritioned_counts_for_users(this.firstimpression_users_power))
        let result_fisher = await pyfunc('fisher_exact', get_attritioned_nonattritioned_counts_for_users(this.firstimpression_users_none), get_attritioned_nonattritioned_counts_for_users(this.firstimpression_users_power))
        console.log('fisher exact test')
        console.log(result_fisher)
        let lifetimes1 = await get_lifetimes_and_whether_attrition_was_observed_for_users(this.firstimpression_users_none)
        let lifetimes2 = await get_lifetimes_and_whether_attrition_was_observed_for_users(this.firstimpression_users_info)
        let lifetimes3 = await get_lifetimes_and_whether_attrition_was_observed_for_users(this.firstimpression_users_power)
        console.log(lifetimes1.attritions)
        console.log(lifetimes2.attritions)
        console.log(lifetimes3.attritions)
        console.log(lifetimes1.attritions.filter(x => x == 1).length / lifetimes1.attritions.length)
        console.log(lifetimes2.attritions.filter(x => x == 1).length / lifetimes2.attritions.length)
        console.log(lifetimes3.attritions.filter(x => x == 1).length / lifetimes3.attritions.length)
        //console.log(JSON.stringify({
        //  all_of_defaults: lifetimes1,
        //  half_of_defaults: lifetimes2,
        //  one: lifetimes3,
        //}))
        let result = await pyfunc('logrank_test', lifetimes1, lifetimes3)
        console.log(result)
        console.log('p value ' + result.__StatisticalResult__.p_value)
        console.log('======== csv data ===========')
        console.log(await json2csv.json2csvPromisified(csv_data))
        console.log('======== csv data per day ============')
        console.log(await json2csv.json2csvPromisified(csv_data_perday))
        console.log('========= userid to day info list =============')
        console.log(JSON.stringify(userid_to_day_info_list))
      },
    })
  </script>
</dom-module>
