<!DOCTYPE html>
<html>

<head>
  Log Analysis
  <script src="bower_components/moment/moment.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/localforage/dist/localforage.min.js"></script>
  <script src="bower_components/mathjs/dist/math.min.js"></script>
  <script src="bower_components/prelude-ls/browser/prelude-browser-min.js"></script>
  <script src="libfrontend.js"></script>

  <link rel="import" href="bower_components/polymer/polymer.html">
  <link rel="import" href="bower_components/google-chart/google-chart.html">
</head>

<body>
  analysis
  <p id="test_section"></p>
  <script>
    //window.prelude = require('prelude-ls')
    console.log('Beginning test loggings\n')
    console.log('log for test user')
    const test_user = '12a641126b3874b179b6ebf7'
    async function print_test() {
      let test_data = await get_collection_for_user(test_user, 'logs:interventions')
      console.log(test_data)
    }

    print_test()

    async function intervention_data_for_usernames(usernames, job_name) {
      console.log(usernames.length + " usernames found")
      let intervention_data = {}
      var count = 0
      for (let username of usernames) {
        if (count % 100 == 0) console.log(job_name + " is " + 
          Math.floor(count / usernames.length * 100) + "% done.")
        let user_data = await get_collection_for_user(username, 'logs:interventions')
        var shows_default = false
        if (user_data.length > 0) {
          for (let i in user_data) {
            if (user_data[i].type == "default_interventions_on_install") {
              shows_default = true
              break
            }
          }
          if (shows_default) {
            console.log(user_data)
            intervention_data[username] = user_data
          }
        }
        count += 1
      }
      console.log(intervention_data)
      return intervention_data
    }

    async function avg_attrition_by_initial_condition(for_website, user_to_install_times, user_to_uninstall_times, intervention_data) {
        var user_condition_counts = {}
        var user_condition_avg_times = {}
        for(let username of intervention_data) {
          if(intervention_data[username].length > 1) {
            console.log("multiple default configuration entries - this case doesn't make any sense to me")
            continue
          }
          // count number of enabled interventions for the for_website
          var count = 0
          for(let intervention_name of Object.keys(intervention_data[username][0].default_enabled_interventions)) {
            if(intervention_name.indexOf(for_website) != -1) {
              count += 1
            }
          }
          let time_until_uninstall = user_to_uninstall_times[username] - user_to_install_times[username]
          if(user_condition_counts[count]) {
            user_condition_counts[count] += 1
            user_condition_avg_times[count] += time_until_uninstall
          } else {
            user_condition_counts[count] = 1
            user_condition_avg_times[count] = time_until_uninstall
          }
          for(let key of Object.keys(user_condition_counts)) {
            user_condition_avg_times[key] /= user_condition_counts[key]
          }
        }
        return user_condition_avg_times
      }

    async function main() {
      let user_to_install_times = await get_user_to_install_times()
      if(Object.keys(user_to_install_times).indexOf(test_user) == -1) {
        console.log("test not in install times")
      }
      let user_to_uninstall_times = await get_user_to_uninstall_times()
      if(Object.keys(user_to_uninstall_times).indexOf(test_user) == -1) {
        console.log("test not in uninstall times")
      }
      var usernames = []
      for (let username of Object.keys(user_to_uninstall_times)) {
        if (user_to_install_times[username]) {
          usernames.push(username)
        }
      }
      let intervention_data = await intervention_data_for_usernames(usernames, "job 1")
      //usernames = Object.keys(user_to_install_times)
      //intervention_data_for_usernames(usernames, "job 2")

    }

    main()



  </script>

</body>

</html>