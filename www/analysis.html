<!DOCTYPE html>
<html>

<head>
  Log Analysis
  <script src="bower_components/moment/moment.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/localforage/dist/localforage.min.js"></script>
  <script src="bower_components/mathjs/dist/math.min.js"></script>
  <script src="bower_components/prelude-ls/browser/prelude-browser-min.js"></script>
  <script src="libfrontend.js"></script>

  <link rel="import" href="bower_components/polymer/polymer.html">
  <link rel="import" href="bower_components/google-chart/google-chart.html">
</head>

<body>
  analysis
  <p id="test_section"></p>
  <script>
    //window.prelude = require('prelude-ls')
    console.log('Beginning test loggings\n')
    console.log('log for test user')
    const test_user = '12a641126b3874b179b6ebf7'
    async function print_test() {
      let test_data = await get_collection_for_user(test_user, 'logs:interventions')
      console.log(test_data)
    }

    print_test()

    async function intervention_data_for_usernames(usernames, job_name) {
      console.log(usernames.length + " usernames found")
      let intervention_data = {}
      var count = 0
      for (let username of usernames) {
        if (count % 100 == 0) console.log(job_name + " is " + 
          Math.floor(count / usernames.length * 100) + "% done.")
        let user_data = await get_collection_for_user(username, 'logs:interventions')
        var shows_default = false
        if (user_data.length > 0) {
          for (let i in user_data) {
            if (user_data[i].type == "default_interventions_on_install") {
              shows_default = true
              break
            }
          }
          if (shows_default) {
            console.log(user_data)
            intervention_data[username] = user_data
          }
        }
        count += 1
      }
      console.log(intervention_data)
      return intervention_data
    }

    async function find_default_interventions_entry(user_data) {
      for (x of user_data) {
        if (x.type == 'default_interventions_on_install') return x
      }
      return null
      /*
      var result = -1
          for(let i in user_data) {
            if(user_data[i].type == "default_interventions_on_install") {
              result = i
              break
            }
          }
      return result
      */
    }

    // install to uninstall less than an hour might be noisy -
    async function avg_attrition_by_initial_condition(user_to_install_times, user_to_uninstall_times, intervention_data) {
        var user_condition_counts = {}
        var user_condition_avg_times = {}
        for(let username of Object.keys(intervention_data)) {
          let entry = find_default_interventions_entry(intervention_data[username])
          if(entry == null) continue
          let user_condition = entry.interventions_per_goal
          if(user_condition == null) continue
          console.log(user_condition)

          end = moment(user_to_uninstall_times[username])
          start = moment(user_to_install_times[username])
          let time_until_uninstall = moment.duration(end.diff(start)).asDays()
          console.log(user_to_uninstall_times[username])
          console.log(user_to_install_times[username])
          if(user_condition_counts[user_condition]) {
            user_condition_counts[user_condition] += 1
            user_condition_avg_times[user_condition] += time_until_uninstall
          } else {
            user_condition_counts[user_condition] = 1
            user_condition_avg_times[user_condition] = time_until_uninstall
          }
          for(let key of Object.keys(user_condition_counts)) {
            user_condition_avg_times[key] /= user_condition_counts[key]
          }
        }
        return [user_condition_avg_times, user_condition_counts]
      }

    async function main() {
      let user_to_install_times = await get_user_to_install_times()
      let user_to_uninstall_times = await get_user_to_uninstall_times()
      var usernames = []
      for (let username of Object.keys(user_to_uninstall_times)) {
        if (user_to_install_times[username]) {
          usernames.push(username)
        }
      }
      let intervention_data = await intervention_data_for_usernames(usernames, "job 1")
      //usernames = Object.keys(user_to_install_times)
      //intervention_data_for_usernames(usernames, "job 2")
      let result = await avg_attrition_by_initial_condition(
        user_to_install_times, user_to_uninstall_times, intervention_data)
      let user_condition_avg_times = result[0]
      let user_condition_counts = result[1]
      console.log("average times")
      console.log(user_condition_avg_times)
      console.log("sample counts")
      console.log(user_condition_counts)

    }

    main()



  </script>

</body>

</html>