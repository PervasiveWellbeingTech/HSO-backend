<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<dom-module id="failed_intervention_display">
  <template>
    <style>
      :root {
        width: 100%;
      }

      google-chart {
        width: 100%;
      }
    </style>
    <template is="dom-repeat" items="{{domain_and_intervention_failure_list}}" as="domain_and_intervention_failure">
      <div>{{domain_and_intervention_failure.domain}}</div>
      <google-chart type="column" id="failure_display" cols='[{"label": "Data", "type": "string"},{"label": "Count", "type": "number"}]'
        rows="{{domain_and_intervention_failure.intervention_info_list}}"></google-chart>
    </template>
  </template>
  <script>
    async function get_short_users() {
      var found_count = 0
      let user_to_install_times = await get_user_to_install_times()
      let user_to_uninstall_times = await get_user_to_uninstall_times()
      var one_day_users = []
      for (let username of Object.keys(user_to_uninstall_times)) {
        if(found_count > 10) break
        found_count++
        end = moment(user_to_uninstall_times[username])
        start = moment(user_to_install_times[username])
        let time_until_uninstall = end.diff(start, 'days')
        console.log(time_until_uninstall)
        if (time_until_uninstall <= 1 && time_until_uninstall >= 0) {
          console.log("found one")
          one_day_users.push(username)
        }
      }
      return one_day_users
    }

    async function get_short_count(intervention, short_users) {
      console.log(intervention)
      var short_count = 0
      for (let user of short_users) {
        intervention = intervention.replace('/', ':')
        let user_data = await get_collection_for_user(user, intervention)
        if (user_data != []) {
          short_count++
        }
      }
      return short_count
    }

    function count_logs_for_user(intervention_logs, intervention_to_short_count) {
      console.log('intervention log')
      console.log(intervention_logs)
      for(let intervention of intervention_logs) {
        if(intervention in intervention_to_short_count) {
          intervention_to_short_count[intervention] += 1
        } else {
          intervention_to_short_count[intervention] = 1
        }
      }
       return intervention_to_short_count
    }

    async function get_intervention_to_short_count(short_users) {
      var intervention_to_short_count = {}
      for(let user of short_users) {
        let intervention_logs = await list_intervention_logs_for_user(user)
        intervention_to_short_count = count_logs_for_user(intervention_logs, intervention_to_short_count)
      }
      return intervention_to_short_count
    }

    async function count_sites_for_user(username, intervention_to_user_counts, intervention_names) {
      for (let intervention of intervention_names) {
        let user_data = await get_collection_for_user(username, intervention)
        if (user_data != []) {
          if (intervention in intervention_to_user_counts) {
            intervention_to_user_counts[intervention] += 1
          } else {
            intervention_to_user_counts[intervention] += 1
          }
        }
      }
      return intervention_to_user_counts
    }

    Polymer({
      is: 'intervention-failure-display',
      properties: {
        userid: {
          type: 'String',
          observer: 'userid_changed'
        },
        domain_and_intervention_failure_list: {
          type: Array,
        }
      },
      userid_changed: async function () {
        let userid = this.userid
        if (!userid) {
          return
        }
        let domain_to_intervention_to_session_lengths;
        if (userid == 'all') {
          domain_to_intervention_to_session_lengths = await get_session_lengths_with_intervention_all_users()
        } else {
          domain_to_intervention_to_session_lengths = await get_session_lengths_with_intervention(userid)
        }
        let short_users = await get_short_users()
        console.log(short_users)
        let domain_and_intervention_failure_list = []
        let intervention_to_short_count = await get_intervention_to_short_count(short_users)
        console.log(intervention_to_short_count)
        console.log('here')
        for (let domain of Object.keys(domain_to_intervention_to_session_lengths)) {
          let intervention_info_list = []
          let intervention_to_session_lengths = domain_to_intervention_to_session_lengths[domain]
          for (let intervention_name of Object.keys(intervention_to_session_lengths)) {
            //let short_count = await get_short_count(intervention_name, short_users)
            let short_count = intervention_to_short_count[intervention_name.replace('/', ':')]
            if(short_count == null) continue
            console.log(intervention_name)
            console.log(short_count)
            let tooltip = `
          Intervention: ${intervention_name}<br>
          1-day Drop Count: ${short_count}<br>
          `
            intervention_info_list.push([
              intervention_name,
              short_count
            ])
          }
          domain_and_intervention_failure_list.push({
            domain: domain,
            intervention_info_list: intervention_info_list
          })
        } 
        console.log(domain_and_intervention_failure_list)
        this.domain_and_intervention_failure_list = domain_and_intervention_failure_list
      }
    });
  </script>

</dom-module>